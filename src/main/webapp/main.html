<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>El bosque del eco</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* Overlay de inicio */
        #audio-start-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            color: white;
            font-size: 24px;
            font-family: sans-serif;
            transition: opacity 0.5s;
        }

        #audio-start-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }
    </style>
</head>
<body>

<!-- Música de fondo -->
<audio id="bg-music" src="sounds/background.wav" loop volume="0.3"></audio>

<!-- Overlay de inicio -->
<div id="audio-start-overlay">
    Haz clic para iniciar la aventura
</div>

<!-- IFrame principal del juego -->
<iframe id="game-frame"
        src="index.jsp"
        name="game-frame"
        frameborder="0">
</iframe>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const bgMusic = document.getElementById('bg-music');
        const overlay = document.getElementById('audio-start-overlay');
        const gameFrame = document.getElementById('game-frame');
        const playerName = localStorage.getItem('playerName');
        const introPlayed = localStorage.getItem('introPlayed'); // nuevo flag

        // Mostrar overlay solo la primera vez que se abre el juego
        if (!introPlayed) {
            overlay.classList.remove('hidden');
            overlay.addEventListener('click', () => {
                bgMusic.play().then(() => {
                    overlay.classList.add('hidden');
                    setTimeout(() => overlay.remove(), 500);

                    // Guardar que ya se mostró la intro
                    localStorage.setItem('introPlayed', 'true');
                }).catch(() => {
                    console.warn("El navegador bloqueó el audio, requiere otro clic.");
                });
            }, { once: true });
        } else {

            // Si ya se jugó la intro, reproducir directamente la música y quitar overlay
            overlay.remove();
            try {
                bgMusic.play().catch(() => {});
            } catch (e) {}
            gameFrame.addEventListener('load', () => {
                try { bgMusic.play().catch(() => {}); } catch (e) {}
            });
        }

        //  Detecta fallos reales, no recargas normales
        let lastCheckTime = Date.now();

        setInterval(() => {
            const frameDoc = gameFrame.contentDocument || gameFrame.contentWindow.document;
            if (!frameDoc) return;

            const bodyText = frameDoc.body ? frameDoc.body.innerText.trim() : "";
            const bodyHtml = frameDoc.body ? frameDoc.body.innerHTML.trim() : "";

            // Si el iframe tiene contenido válido (texto, botones, imágenes), no hacer nada
            if (bodyText.length > 50 || bodyHtml.includes("<img") || bodyHtml.includes("<button")) {
                lastCheckTime = Date.now();
                return;
            }

            // Si el iframe lleva más de 10 segundos sin contenido visible → probablemente error real
            if (Date.now() - lastCheckTime > 10000) {
                console.warn("⚠️ Iframe detectado vacío por más de 10s, recargando...");
                gameFrame.src = "index.jsp?" + Date.now();
                lastCheckTime = Date.now();
            }
        }, 3000);
    });
</script>
</body>
</html>
